---
title: "Constructing PGLS dataset for CCA species with functional and life-history trait data"
author: "Anne-Cecile Colin"
date: "10/06/2021"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(devtools)
library(readr)
library(sp)
library(raster)
library(stats)
library(plyr)
library(dplyr)
library(readxl)
library(ggplot2)
library(ggtree)
library(conflicted)
library(ape)
library(data.table)
```

## Merging life-history trait data to CCA# by = species

``` {r adding life-history data}

CCAnumber <- read.csv("../data/life_history_CCA.csv", header = T)
view(CCAnumber)
nrow(CCAnumber)

species <- read.csv("../data/CCA_VPM_species_PGLS.csv", header = T) %>%
  distinct(acceptedname_ala, .keep_all = TRUE)
species <- species[!(species$Taxonresolution_ALA=="Hybrid") | species$Taxonresolution_ALA=="Variety",]
colnames(species)[4] <- "name"
nrow(species)
view(species)
write.csv(species, "../outputs/VPM_species.csv") # just to check the number of species in each genus

trait.ds <- full_join(species, CCAnumber, by = "name") %>%
  distinct(name, .keep_all = T) %>%
  drop_na(FieldID)

view(trait.ds)
nrow(trait.ds)

write.csv(trait.ds, "../outputs/full.df.first.draft.csv") # add file name
```

## How many species from the dataset don't have life-history traits? Merging Victoria CCA species directly with euclid trait from Desi

``` {r EUCLID to Victoria species}
EUCLID <- read.csv("../data/euc_traits_from_EUCLID.csv", header = T)
view(EUCLID)
nrow(EUCLID)

test.full.df <- left_join(species, EUCLID, by = "name")
nrow(test.full.df)
write.csv(test.full.df, "../outputs/test.full.lifehist.df.csv")
```
There are 823 species in the flora dataset and 930 in Victoria's.
Corymbia and Angophora species have no trait data (96), 

## How many species in CCA don't have flora traits?
``` {r}
test.df <- left_join(EUCLID, species, by = "name")
nrow(test.df)

```
There are 930 taxa in Victoria's dataset and 823 are matching with taxa from the flora traits.



## Getting Thornhill's phylo species as csv to 

``` {r Thornhills species}
tree <- read.tree("../data/Eucalypts_ML2_dated_r8s.tre",)
thornhill.species <- as.data.frame(tree$tip.label)
view(thornhill.species)
df <- data.frame(matrix(unlist(thornhill.species), nrow=length(thornhill.species), byrow=TRUE))
write.csv(df, "../outputs/datasets_in_progress/thornhill.species.list.csv")
```

```{r cleaning thornhill phylo}
thornhill <- read.csv("../data/thornhill_species_list.csv", header = T) #%>%
  setDT(thornhill)[, paste0("taxon", 1:7) := tstrsplit(species, "_")]
write.csv(thornhill, "../outputs/split_thornhill_data.csv")
```

## How many species from Victoria list not found in Thornhill phylo? trying to merge based on species name
thornhill's phylogeny has species names based on Dean's taxonomy so it's supposed to match perfectly with victoria's species based on Dean's taxonomy name.

``` {r matching victoria and thornhill datasets}
thornhill.species <- read.csv("../outputs/datasets_in_progress/split_thornhill_data.csv", header = T)
view(thornhill.species)
victoria.species <- read.csv("../outputs/VPM_species.csv", header = T)
nrow(thornhill.species)
nrow(victoria.species)

thornhill.vic.df <- left_join(victoria.species, thornhill.species, by = "name")
view(thornhill.vic.df)
write.csv(thornhill.vic.df, "../outputs/datasets_in_progress/Victoria_thornhill_merge.csv")
```

If everything is fine, the only data missing now in the merged dataset corresponds to taxa that Victoria has but were not included in the phylogeny (so we'll have to suss out the phylo signal for those ones)

Now let's try to add the functional trait to the back end of that, and depending were the gaps are across the three datasets we'll know if it's a lack of data because EUCLID simply doesn't have data for those taxa or if it's dubious taxa and a species in EUCLID is actually a subspecies in Thornhill/DN.

```{r second merging with life-history traits from EUCLID}
Victoria.thornhill.merge.df <- read.csv("../outputs/datasets_in_progress/Victoria_thornhill_merge.csv", header = T)
n=1
nrow(Victoria.thornhill.merge.df)
view(Victoria.thornhill.merge.df)
EUCLID.traits.df <- read.csv("../data/euc_traits_from_EUCLID.csv", header = T)
view(EUCLID.traits.df)
nrow(EUCLID.traits.df)

Victoria_EUCLID_merge <- left_join(victoria.species, EUCLID.traits.df, by = c("name" = "name1"))
view(Victoria_EUCLID_merge)
nrow(Victoria_EUCLID_merge)
write.csv(Victoria_EUCLID_merge, "../outputs/datasets_in_progress/Victoria_EUCLID_merge.csv")

df.full.double.merge <- dplyr::left_join(Victoria.thornhill.merge.df, EUCLID.traits.df, by=c("DNname" = "name1", "ALAname" = "name2")) #merging according to ALA names and DN names across Victoria's and EUCLID data
nrow(df.full.double.merge)
view(full.merge.df)
write.csv(df.full.double.merge, "../outputs/datasets_in_progress/victoria_thornhill_euclid_doublemerge.csv")
```

## Making the phylogeny's tip labels match with victoria's dataset:

``` {r changing phylo tip labels}
thornhill_labels <- read.csv("../data/tree_labels.csv")
tree <- read.tree("../data/Eucalypts_ML2_dated_r8s.tre")

tree$tip.label<-thornhill_labels$name3[match(tree$tip.label, thornhill_labels$original)] # changing tip label to match victoria species name
tree$tip.label<-sapply(tree$tip.label, function(x) parse(text=x))
ggtree(tree)
plot(tree)
ggsave("../plots/test.pdf", width = 50, height = 120, limitsize = FALSE)
```


